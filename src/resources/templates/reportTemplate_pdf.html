<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reporte de Validaciones Salesforce Apex</title>
    <style>
        body {
            font-family: "Segoe UI", Arial, sans-serif;
            margin: 24px;
            color: #1a2433;
            background: #ffffff;
        }

        h1 {
            margin: 0 0 20px;
            padding: 12px 16px;
            font-size: 1.8rem;
            color: #ffffff;
            background: #1f62b4;
            border-radius: 8px;
        }

        h2 {
            margin-top: 28px;
            margin-bottom: 12px;
            font-size: 1.25rem;
            color: #1a2433;
            border-bottom: 2px solid #1f62b4;
            padding-bottom: 6px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }

        th, td {
            border: 1px solid #d0d5dd;
            padding: 8px 10px;
            text-align: left;
        }

        th {
            background: #2a7de1;
            color: #ffffff;
        }

        tr:nth-child(even) {
            background: #f5f7fb;
        }

        .summary-grid {
            display: table;
            width: 100%;
            table-layout: fixed;
            margin-bottom: 28px;
        }

        .summary-card {
            display: table-cell;
            width: 25%;
            padding: 16px;
            vertical-align: top;
            border: 1px solid #d0d5dd;
        }

        .summary-card:not(:last-child) {
            border-right: none;
        }

        .summary-card .summary-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #1f62b4;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .summary-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 1rem;
            font-weight: 700;
            color: #ffffff;
            font-family: "Segoe UI Symbol", "DejaVu Sans", Arial, sans-serif;
        }

        .summary-icon.alert { background: #d12f2f; }
        .summary-icon.tests { background: #1f62b4; }
        .summary-icon.coverage { background: #f59f00; }
        .summary-icon.duplicates { background: #6f42c1; }

        .summary-card strong {
            display: block;
            font-size: 1.6rem;
            margin: 4px 0;
            color: #1a2433;
        }

        .summary-card > span {
            font-size: 0.9rem;
            color: #3b4656;
        }

        .empty-state {
            margin: 12px 0;
            padding: 12px;
            border-radius: 6px;
            font-weight: 600;
        }

        .empty-state.success {
            background: #e8f5ec;
            color: #1c8b57;
            border: 1px solid #a8d5b8;
        }

        .empty-state.info {
            background: #e5f4ff;
            color: #1f62b4;
            border: 1px solid #aacdf1;
        }

        .empty-state.warning {
            background: #fff8e5;
            color: #c77a1e;
            border: 1px solid #f1d199;
        }

        pre {
            background: #f5f7fb;
            padding: 10px;
            border-radius: 4px;
            font-family: Consolas, "Courier New", monospace;
            white-space: pre-wrap;
            word-break: break-word;
            border: 1px solid #d0d5dd;
        }

        .analysis h2,
        .analysis h3,
        .analysis h4 {
            color: #1f62b4;
            margin-top: 16px;
        }

        .analysis-block {
            margin-bottom: 20px;
            padding: 16px;
            border: 1px solid #d0d5dd;
            border-radius: 6px;
        }

        .analysis-block .class-name {
            display: inline-block;
            background: #eef2fb;
            color: #1f62b4;
            padding: 4px 8px;
            border-radius: 14px;
            font-weight: 600;
        }

        .report-meta {
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #3b4656;
        }
    </style>
</head>
<body>
    <h1>Reporte de Validaciones Salesforce Apex</h1>

    <div class="summary-grid">
        <div class="summary-card">
            <div class="summary-header">
                <span class="summary-icon alert">!</span>
                <span>Problemas</span>
            </div>
            <strong>{{ apex_results | length }}</strong>
            <span>Reglas que requieren atención</span>
        </div>
        <div class="summary-card">
            <div class="summary-header">
                <span class="summary-icon tests">&#x2697;</span>
                <span>Pruebas ejecutadas</span>
            </div>
            <strong>{{ test_results | length }}</strong>
            <span>Resultados de clases de prueba</span>
        </div>
        <div class="summary-card">
            <div class="summary-header">
                <span class="summary-icon coverage">&#x25BC;</span>
                <span>Cobertura &lt; 75%</span>
            </div>
            <strong>{{ low_coverage_count }}</strong>
            <span>Clases por debajo del umbral</span>
        </div>
        <div class="summary-card">
            <div class="summary-header">
                <span class="summary-icon duplicates">&#x2263;</span>
                <span>Código duplicado</span>
            </div>
            <strong>{{ duplicate_class_count }}</strong>
            <span>Clases con coincidencias detectadas</span>
        </div>
    </div>

    <h2>Problemas Detectados</h2>
    {% if apex_results %}
    <table>
        <tr>
            <th>Clase</th>
            <th>Línea</th>
            <th>Regla</th>
            <th>Severidad</th>
            <th>Descripción</th>
            <th>Referencia</th>
        </tr>
        {% for issue in apex_results %}
        <tr>
            <td>{{ issue.clase }}</td>
            <td>{{ issue.linea }}</td>
            <td>{{ issue.regla }}</td>
            <td>{{ issue.severidad }}</td>
            <td>{{ issue.descripcion }}</td>
            <td>{% if issue.recurso %}{{ issue.recurso }}{% else %}-{% endif %}</td>
        </tr>
        {% endfor %}
    </table>
    {% else %}
    <div class="empty-state success">No se encontraron problemas.</div>
    {% endif %}

    <h2>Cobertura de Código</h2>
    {% if test_coverage %}
    <table>
        <tr>
            <th>Clase</th>
            <th>Líneas Totales</th>
            <th>Cubiertas</th>
            <th>Cobertura %</th>
        </tr>
        {% for c in test_coverage %}
        <tr{% if c.isLowCoverage %} style="color: #c77a1e;"{% endif %}>
            <td>{{ c.ClassName }}</td>
            <td>{{ c.TotalLines }}</td>
            <td>{{ c.CoveredLines }}</td>
            <td>{{ c.CoveragePercentage }}</td>
        </tr>
        {% endfor %}
    </table>
    {% else %}
    <div class="empty-state info">No hay datos de cobertura.</div>
    {% endif %}

    <h2>Resultados de Pruebas</h2>
    {% if test_results %}
    <table>
        <tr>
            <th>Clase</th>
            <th>Método</th>
            <th>Resultado</th>
            <th>Mensaje</th>
        </tr>
        {% for t in test_results %}
        <tr>
            <td>{{ t.class_name }}</td>
            <td>{{ t.method_name }}</td>
            <td>{{ t.outcome }}</td>
            <td>{{ t.message }}</td>
        </tr>
        {% endfor %}
    </table>
    {% else %}
    <div class="empty-state warning">No se ejecutaron pruebas.</div>
    {% endif %}

    <h2>Código duplicado</h2>
    {% if pmd_results %}
    <table>
        <tr>
            <th>Clase</th>
            <th>Líneas duplicadas</th>
            <th>Fragmento</th>
        </tr>
        {% for dup in pmd_results %}
        <tr>
            <td>{{ dup.clases | replace(',', ', ') }}</td>
            <td>{{ dup.lines }}</td>
            <td><pre>{{ dup.codeSnippet }}</pre></td>
        </tr>
        {% endfor %}
    </table>
    {% else %}
    <div class="empty-state success">No se encontraron duplicados.</div>
    {% endif %}

    <h2>Análisis IA</h2>
    {% if einsteinAnalysis %}
    {% for cls, analysis in einsteinAnalysis %}
    <section class="analysis-block">
        <span class="class-name">{{ cls }}</span>
        <div class="analysis">{{ analysis.resumenHtml | safe }}</div>
    </section>
    {% endfor %}
    {% else %}
    <div class="empty-state info">El análisis IA fue omitido o no se encontraron resultados.</div>
    {% endif %}
</body>
</html>